pipeline {
    agent any

    environment {
        APP_NAME      = 'expense-manager'
        APP_PORT      = '5001'
        BUILD_VERSION = "${BUILD_NUMBER}"
        MAVEN_CACHE   = 'maven-repo'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 60, unit: 'MINUTES')
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code...'
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        stage('Setup') {
            steps {
                echo 'üîß Setting up environment...'
                dir('manager') {
                    sh '''
                        mkdir -p target/allure-results
                        mkdir -p target/surefire-reports
                        docker volume create ${MAVEN_CACHE} || true
                        docker --version
                    '''
                }
            }
        }

        stage('Unit Tests') {
            steps {
                echo 'üß™ Running unit tests...'
                dir('manager') {
                    sh '''
                        docker run --rm \
                          -v $(pwd):/app \
                          -v ${MAVEN_CACHE}:/root/.m2 \
                          -w /app \
                          maven:3.9-eclipse-temurin-17 \
                          mvn test \
                            -Dtest="**/unit_tests/**/*Test.java" \
                            -DfailIfNoTests=false \
                            -B
                    '''
                }
            }
            post {
                always {
                    junit allowEmptyResults: true,
                          testResults: 'manager/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Code Coverage') {
            steps {
                echo 'üìà Generating JaCoCo report...'
                dir('manager') {
                    sh '''
                        docker run --rm \
                          -v $(pwd):/app \
                          -v ${MAVEN_CACHE}:/root/.m2 \
                          -w /app \
                          maven:3.9-eclipse-temurin-17 \
                          mvn jacoco:report -B
                    '''
                }
            }
            post {
                always {
                    jacoco(
                        execPattern: 'manager/target/jacoco.exec',
                        classPattern: 'manager/target/classes',
                        sourcePattern: 'manager/src/main/java',
                        exclusionPattern: '**/*Test*.class'
                    )
                }
            }
        }

        stage('Build JAR') {
            steps {
                echo 'üì¶ Building application JAR...'
                dir('manager') {
                    sh '''
                        docker run --rm \
                          -v $(pwd):/app \
                          -v ${MAVEN_CACHE}:/root/.m2 \
                          -w /app \
                          maven:3.9-eclipse-temurin-17 \
                          mvn clean package -DskipTests -B
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                dir('manager') {
                    sh '''
                        docker build \
                          -t ${APP_NAME}:${BUILD_VERSION} \
                          -t ${APP_NAME}:latest \
                          .
                        docker images | grep ${APP_NAME}
                    '''
                }
            }
        }

        stage('Start App for E2E Tests') {
            steps {
                echo 'üöÄ Starting application...'
                sh '''
                    docker stop ${APP_NAME}-test 2>/dev/null || true
                    docker rm ${APP_NAME}-test 2>/dev/null || true
                    docker volume create expense-test-data || true

                    docker run -d \
                      --name ${APP_NAME}-test \
                      -p ${APP_PORT}:${APP_PORT} \
                      -v expense-test-data:/data \
                      -e DATABASE_PATH=/app/db/test_expense_manager.db \
                      ${APP_NAME}:${BUILD_VERSION}

                    echo "Waiting for health check..."
                    for i in {1..60}; do
                        if curl -f http://localhost:${APP_PORT}/health; then
                            echo "‚úÖ App is healthy"
                            exit 0
                        fi
                        sleep 2
                    done

                    echo "‚ùå App failed to start"
                    docker logs ${APP_NAME}-test
                    exit 1
                '''
            }
        }

        stage('E2E Tests (Cucumber + Selenium)') {
            steps {
                dir('manager') {
                    sh '''
                        docker run -d \
                          --name selenium-chrome \
                          -p 4444:4444 \
                          --shm-size=2g \
                          selenium/standalone-chrome:latest

                        for i in {1..30}; do
                          curl -f http://localhost:4444/wd/hub/status && break
                          sleep 2
                        done

                        docker run --rm \
                          -v $(pwd):/app \
                          -v ${MAVEN_CACHE}:/root/.m2 \
                          -w /app \
                          -e APP_URL=http://host.docker.internal:${APP_PORT} \
                          -e SELENIUM_REMOTE_URL=http://host.docker.internal:4444/wd/hub \
                          maven:3.9-eclipse-temurin-17 \
                          mvn test \
                            -Dtest="com.revature.end_to_end_tests.runners.TestRunner" \
                            -DfailIfNoTests=false \
                            -B || true
                    '''
                }
            }
            post {
                always {
                    sh '''
                        docker stop selenium-chrome || true
                        docker rm selenium-chrome || true
                    '''
                }
            }
        }
    }

    post {
        always {
            sh '''
                docker stop ${APP_NAME}-test || true
                docker rm ${APP_NAME}-test || true
            '''
            archiveArtifacts artifacts: 'manager/target/*.jar', allowEmptyArchive: false
        }
        success {
            echo '‚úÖ Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed'
        }
    }
}