// Manager App (Java/Javalin) - Jenkins CI/CD Pipeline
// Comprehensive Testing with Allure Reports and Docker Deployment

pipeline {
    agent any

    environment {
        APP_NAME = 'expense-manager'
        APP_PORT = '5001'
        BUILD_VERSION = "${BUILD_NUMBER}"
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.WORKSPACE}"
        MAVEN_CACHE = 'maven-repo'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 60, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code...'
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        stage('Setup') {
            steps {
                echo 'üîß Setting up build environment...'
                dir('manager') {
                    sh '''
                        mkdir -p target/allure-results
                        mkdir -p target/surefire-reports
                        docker --version
                        docker volume create ${MAVEN_CACHE} || true
                    '''
                }
            }
        }

        stage('Unit Tests') {
            steps {
                echo 'üß™ Running Unit Tests...'
                dir('manager') {
                    sh '''
                    ./mvnw test \
                    -Dtest="**/unit_tests/**/Test*.java" \
                    -DfailIfNoTests=false \
                    -B
                    '''
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Code Coverage') {
            steps {
                echo 'üìà Generating JaCoCo Coverage Report...'
                dir('manager') {
                    sh '''
                        ./mvnw jacoco:report -B
                    '''
                }
            }
            post {
                always {
                    recordCoverage(
                        tools: [[parser: 'JACOCO']],
                        id: 'jacoco', 
                        name: 'JaCoCo Coverage',
                        sourceCodeRetention: 'EVERY_BUILD',
                        qualityGates: [
                            [threshold: 60.0, metric: 'LINE', baseline: 'PROJECT', unstable: true],
                            [threshold: 60.0, metric: 'BRANCH', baseline: 'PROJECT', unstable: true]
                        ]
                    )
                }
            }
        }

        stage('Build Application') {
            steps {
                echo 'üì¶ Building JAR file...'
                dir('manager') {
                    sh '''
                        ./mvnw clean package -DskipTests -B
                    '''
                }
            }
        }

        stage('Start Application in Background') {
            steps {
                echo 'üöÄ Starting Application...'
                dir('manager') {
                    sh '''
                        # Find the JAR file
                        JAR_FILE=$(find target -name "*.jar" -type f | grep -v original | head -n 1)
                        echo "Starting application: $JAR_FILE"
                        
                        # Start the application in the background
                        java -jar $JAR_FILE > app.log 2>&1 &
                        APP_PID=$!
                        echo $APP_PID > app.pid
                        echo "Application started with PID: $APP_PID"
                        
                        # Wait for application to start
                        echo "‚è≥ Waiting for application to start..."
                        sleep 10
                        
                        # Optional: Wait for health endpoint to be ready
                        export APP_URL=http://localhost:${APP_PORT}
                        MAX_RETRIES=30
                        RETRY_COUNT=0
                        
                        until curl -f ${APP_URL}/actuator/health || curl -f ${APP_URL}/health; do
                            RETRY_COUNT=$((RETRY_COUNT+1))
                            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                                echo "‚ùå Application failed to start within timeout"
                                kill $APP_PID || true
                                exit 1
                            fi
                            echo "Waiting for app to be ready... ($RETRY_COUNT/$MAX_RETRIES)"
                            sleep 2
                        done
                        
                        echo "‚úÖ Application is ready!"
                    '''
                }
            }
        }

        stage('Integration Tests') {
            steps {
                echo 'üß™ Running Integration Tests...'
                dir('manager') {
                    sh '''
                        # Read the PID from file
                        APP_PID=$(cat app.pid)
                        export APP_URL=http://localhost:${APP_PORT}
                        
                        echo "Testing against: ${APP_URL}"
                        
                        # Run integration tests
                        ./mvnw test \
                            -Dtest="**/integration_tests/**/Test*.java" \
                            -Dapp.url=${APP_URL} \
                            -DfailIfNoTests=false \
                            -B
                        
                        echo "‚úÖ Integration tests completed"
                    '''
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Run E2E Tests') {
            steps {
                // Run tests in manager directory
                dir('manager') {
                    sh '''
                        ./mvnw test \
                            -Dtest="com.revature.end_to_end_tests.runners.TestRunner" \
                            -DfailIfNoTests=false \
                            -B || true
                    '''
                }
            }
            post {
                always {
                    dir('manager') {
                        sh '''
                            # Stop the application
                            if [ -f app.pid ]; then
                                APP_PID=$(cat app.pid)
                                echo "üõë Stopping application (PID: $APP_PID)"
                                kill $APP_PID || true
                                sleep 2
                                kill -9 $APP_PID 2>/dev/null || true
                                rm -f app.pid
                            fi
                        '''
                    }
                    junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml, manager/target/cucumber-reports/cucumber.xml'
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'manager/target/cucumber-reports',
                        reportFiles: 'cucumber.html',
                        reportName: 'Cucumber E2E Test Report'
                    ])
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    allure([
                        includeProperties: false,
                        jdk: '',
                        resultPolicy: 'LEAVE_AS_IS',
                        results: [[path: 'manager/target/allure-results']]
                    ])
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                dir('manager') {
                    sh '''
                        docker build \
                            -t ${APP_NAME}:${BUILD_VERSION} \
                            -t ${APP_NAME}:latest \
                            -f Dockerfile .
                        echo "‚úÖ Docker image built successfully"
                        docker images | grep ${APP_NAME}
                    '''
                }
            }
        }

        stage('Start Application container for deployment') {
            steps {
                echo 'üöÄ Starting Manager App for Testing...'
                sh '''
                    # Stop and remove any existing container with the same name
                    docker rm -f ${APP_NAME}-test || true
                    
                    # Run the Docker container
                    docker run -d \
                        --name ${APP_NAME}-test \
                        -p ${APP_PORT}:${APP_PORT} \
                        -e SPRING_PROFILES_ACTIVE=test \
                        -e SERVER_PORT=${APP_PORT} \
                        ${APP_NAME}:${BUILD_VERSION}
                    
                    echo "‚è≥ Waiting for application to start..."
                    sleep 15
                    
                    # Verify the container is running
                    docker ps | grep ${APP_NAME}-test
                    
                    # Check application logs
                    echo "üìã Application logs:"
                    docker logs ${APP_NAME}-test
                    
                    # Check application health (adjust endpoint as needed)
                    echo "üè• Checking application health..."
                    curl -f http://localhost:${APP_PORT}/actuator/health || \
                    curl -f http://localhost:${APP_PORT}/health || \
                    echo "‚ö†Ô∏è Health check endpoint not available, but container is running"
                    
                    echo "‚úÖ Application started successfully on port ${APP_PORT}"
                '''
            }
        }

        // stage('Cleanup Test Container') {
        //     steps {
        //         sh '''
        //             docker stop ${APP_NAME}-test 2>/dev/null || true
        //             docker rm ${APP_NAME}-test 2>/dev/null || true
        //             docker volume rm expense-test-data 2>/dev/null || true
        //         '''
        //     }
        // }
    }

    post {
        always {
            // sh '''
            //     docker stop ${APP_NAME}-test 2>/dev/null || true
            //     docker rm ${APP_NAME}-test 2>/dev/null || true
            //     docker image prune -f || true
            // '''
            archiveArtifacts artifacts: 'manager/target/**/*.jar', allowEmptyArchive: true
        }
        success {
            echo '‚úÖ Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed!'
        }
    }
}