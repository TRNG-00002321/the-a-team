// Manager App (Java/Javalin) - Jenkins CI/CD Pipeline
// Comprehensive Testing with Allure Reports and Docker Deployment

pipeline {
    agent any

    environment {
        APP_NAME = 'expense-manager'
        APP_PORT = '5001'
        BUILD_VERSION = "${BUILD_NUMBER}"
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.WORKSPACE}"
        MAVEN_CACHE = 'maven-repo'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 60, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code...'
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        stage('Setup') {
            steps {
                echo 'üîß Setting up build environment...'
                dir('manager') {
                    sh '''
                        mkdir -p target/allure-results
                        mkdir -p target/surefire-reports
                        docker --version
                        docker volume create ${MAVEN_CACHE} || true
                    '''
                }
            }
        }

        stage('Unit Tests') {
            steps {
                echo 'üß™ Running Unit Tests...'
                dir('manager') {
                    sh '''
                    ./mvnw test \
                    -Dtest="**/unit_tests/**/Test*.java" \
                    -DfailIfNoTests=false \
                    -B
                    '''
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Code Coverage') {
            steps {
                echo 'üìà Generating JaCoCo Coverage Report...'
                dir('manager') {
                    sh '''
                        ./mvnw jacoco:report -B
                    '''
                }
            }
            post {
                always {
                    recordCoverage(
                        tools: [[parser: 'JACOCO']],
                        id: 'jacoco', 
                        name: 'JaCoCo Coverage',
                        sourceCodeRetention: 'EVERY_BUILD',
                        qualityGates: [
                            [threshold: 60.0, metric: 'LINE', baseline: 'PROJECT', unstable: true],
                            [threshold: 60.0, metric: 'BRANCH', baseline: 'PROJECT', unstable: true]
                        ]
                    )
                }
            }
        }

        stage('Build Application') {
                steps {
                    echo 'üì¶ Building JAR file...'
                    dir('manager') {
                        sh '''
                            ./mvnw clean package -DskipTests -B
                        '''
                    }
                }
            }

        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                dir('manager') {
                    sh '''
                        docker build \
                            -t ${APP_NAME}:${BUILD_VERSION} \
                            -t ${APP_NAME}:latest \
                            -f Dockerfile .
                        echo "‚úÖ Docker image built successfully"
                        docker images | grep ${APP_NAME}
                    '''
                }
            }
        }

        stage('Start Application for Testing') {
            steps {
                echo 'üöÄ Starting Manager App for Testing...'
                sh '''
                    # Stop and remove any existing container with the same name
                    docker rm -f ${APP_NAME}-test || true
                    
                    # Run the Docker container
                    docker run -d \
                        --name ${APP_NAME}-test \
                        -p ${APP_PORT}:${APP_PORT} \
                        -e SPRING_PROFILES_ACTIVE=test \
                        -e SERVER_PORT=${APP_PORT} \
                        ${APP_NAME}:${BUILD_VERSION}
                    
                    echo "‚è≥ Waiting for application to start..."
                    sleep 15
                    
                    # Verify the container is running
                    docker ps | grep ${APP_NAME}-test
                    
                    # Check application logs
                    echo "üìã Application logs:"
                    docker logs ${APP_NAME}-test
                    
                    # Check application health (adjust endpoint as needed)
                    echo "üè• Checking application health..."
                    curl -f http://localhost:${APP_PORT}/actuator/health || \
                    curl -f http://localhost:${APP_PORT}/health || \
                    echo "‚ö†Ô∏è Health check endpoint not available, but container is running"
                    
                    echo "‚úÖ Application started successfully on port ${APP_PORT}"
                '''
            }
        }

        stage('Integration Tests') {
            steps {
                echo 'üîó Running Integration Tests...'
                dir('manager') {
                    sh '''
                        # Use localhost since tests run on host, not in container
                        export APP_URL=http://localhost:${APP_PORT}
                        
                        echo "üß™ Testing against: ${APP_URL}"
                        
                        # Verify the app is accessible before running tests
                        curl -f ${APP_URL}/actuator/health || curl -f ${APP_URL}/health || echo "App is running"
                        
                        ./mvnw test \
                            -Dtest="**/integration_tests/**/Test*.java" \
                            -Dapp.url=${APP_URL} \
                            -DfailIfNoTests=false \
                            -B
                        
                        echo "‚úÖ Integration tests completed"
                    '''
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml'
                }
            }
}

        stage('E2E Tests with Cucumber') {
            steps {
                echo 'üåê Running E2E Tests with Cucumber + Selenium...'
                dir('manager') {
                    sh '''
                        docker run -d \
                            --name selenium-chrome \
                            --network host \
                            --shm-size=2g \
                            selenium/standalone-chrome:latest

                        echo "Waiting for Selenium Grid..."
                        for i in {1..30}; do
                            if curl -f http://localhost:4444/wd/hub/status 2>/dev/null; then
                                echo "‚úÖ Selenium Grid ready!"
                                break
                            fi
                            sleep 2
                        done

                        docker run --rm \
                            --network host \
                            -v $(pwd):/app \
                            -v ${MAVEN_CACHE}:/root/.m2 \
                            -w /app \
                            -e APP_URL=http://localhost:${APP_PORT} \
                            -e BROWSER=chrome \
                            -e SELENIUM_REMOTE_URL=http://localhost:4444/wd/hub \
                            maven:3.9-eclipse-temurin-17 \
                            mvn test \
                                -Dtest="com.revature.end_to_end_tests.runners.TestRunner" \
                                -DfailIfNoTests=false \
                                -B || true

                        docker stop selenium-chrome || true
                        docker rm selenium-chrome || true
                    '''
                }
            }
            post {
                always {
                    sh '''
                        docker stop selenium-chrome 2>/dev/null || true
                        docker rm selenium-chrome 2>/dev/null || true
                    '''
                    junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml, manager/target/cucumber-reports/cucumber.xml'
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'manager/target/cucumber-reports',
                        reportFiles: 'cucumber.html',
                        reportName: 'Cucumber E2E Test Report'
                    ])
                }
            }
        }

        stage('Cleanup Test Container') {
            steps {
                sh '''
                    docker stop ${APP_NAME}-test 2>/dev/null || true
                    docker rm ${APP_NAME}-test 2>/dev/null || true
                    docker volume rm expense-test-data 2>/dev/null || true
                '''
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    allure([
                        includeProperties: false,
                        results: [[path: 'manager/target/allure-results']]
                    ])
                }
            }
        }
    }

    post {
        always {
            sh '''
                docker stop ${APP_NAME}-test 2>/dev/null || true
                docker rm ${APP_NAME}-test 2>/dev/null || true
                docker image prune -f || true
            '''
            archiveArtifacts artifacts: 'manager/target/**/*.jar', allowEmptyArchive: true
        }
        success {
            echo '‚úÖ Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed!'
        }
    }
}