// Manager App (Java/Javalin) - Jenkins CI/CD Pipeline
// QA Environment with Comprehensive Testing and Allure Reports

pipeline {
    agent any

    environment {
        // Application image name
        APP_NAME = 'manager-app'
        APP_PORT = '5001'

        // AWS EC2 deployment target
        EC2_HOST = credentials('ec2-deploy-host')
        EC2_USER = 'ec2-user'

        // Build version
        BUILD_VERSION = "${BUILD_NUMBER}"

        // Docker-in-Docker: Host workspace path
        // When Jenkins runs in a container, Docker daemon needs the HOST path
        // Set JENKINS_HOME_HOST in Jenkins container env (e.g., /home/ec2-user/jenkins_home)
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.JENKINS_HOME}/workspace/${env.JOB_NAME}"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ Checking out source code...'
                checkout scm

                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        // ============================================
        // FAIL FAST: Run tests BEFORE building image
        // ============================================

        stage('Unit Tests') {
            steps {
                echo 'ðŸ§ª Running Java Unit Tests with Allure...'
                sh '''
                    docker run --rm \
                        -v ${WORKSPACE_HOST}:/app \
                        -v maven-repo:/root/.m2 \
                        -w /app \
                        maven:3.9-eclipse-temurin-17 \
                        mvn clean test \
                        -Dtest="**/unit/**" \
                        -B
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
                }
            }
        }

        stage('Integration Tests') {
            steps {
                echo 'ðŸ”— Running Java Integration Tests with Real Database...'
                sh '''
                    docker run --rm \
                        -v ${WORKSPACE_HOST}:/app \
                        -v maven-repo:/root/.m2 \
                        -w /app \
                        maven:3.9-eclipse-temurin-17 \
                        mvn test \
                        -Dtest="**/integration/**" \
                        -B
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'target/surefire-reports/*Integration*.xml'
                }
            }
        }

        // ============================================
        // BUILD: Only after tests pass
        // ============================================

        stage('Build Docker Image') {
            steps {
                echo 'â˜• Building Java Manager Application...'
                sh '''
                    docker build \
                        -t ${APP_NAME}:${BUILD_VERSION} \
                        -t ${APP_NAME}:latest \
                        -f Dockerfile .
                '''
            }
        }

        stage('Start Application') {
            steps {
                echo 'ðŸš€ Starting Manager App for API/E2E Testing...'
                sh '''
                    # Stop any existing container
                    docker stop ${APP_NAME}-test || true
                    docker rm ${APP_NAME}-test || true

                    # Start the container
                    docker run -d \
                        --name ${APP_NAME}-test \
                        -p ${APP_PORT}:${APP_PORT} \
                        -v expense-data:/data \
                        ${APP_NAME}:${BUILD_VERSION}

                    # Wait for app to be healthy
                    echo "Waiting for application to start..."
                    sleep 30
                    curl -f http://localhost:${APP_PORT}/health || exit 1
                    echo "âœ… Application is ready!"
                '''
            }
        }

        stage('API Tests') {
            steps {
                echo 'ðŸ”Œ Running Java API Tests (REST Assured + Integration)...'
                sh '''
                    docker run --rm \
                        --network host \
                        -v ${WORKSPACE_HOST}:/app \
                        -v maven-repo:/root/.m2 \
                        -w /app \
                        -e API_BASE_URL=http://localhost:${APP_PORT} \
                        maven:3.9-eclipse-temurin-17 \
                        mvn test \
                        -Dtest="**/api/**" \
                        -Dmaven.test.failure.ignore=true \
                        -B
                '''
            }
        }

        stage('E2E Tests') {
            steps {
                echo 'ðŸŒ Running Java E2E Tests (Cucumber + Integration)...'
                sh '''
                    docker run --rm \
                        --network host \
                        -v ${WORKSPACE_HOST}:/app \
                        -v maven-repo:/root/.m2 \
                        -w /app \
                        -e APP_URL=http://localhost:${APP_PORT} \
                        maven:3.9-eclipse-temurin-17 \
                        mvn test \
                        -Dtest="**/e2e/**" \
                        -Dmaven.test.failure.ignore=true \
                        -B
                '''
            }
        }

        stage('Performance Tests') {
            steps {
                echo 'âš¡ Running JMeter Performance Tests...'
                sh '''
                    if [ -d "tests/performance" ]; then
                        mkdir -p jmeter-results
                        docker run --rm \
                            --network host \
                            -v ${WORKSPACE_HOST}:/workspace \
                            -w /workspace \
                            justb4/jmeter:latest \
                            -n \
                            -t /workspace/tests/performance/*.jmx \
                            -l /workspace/jmeter-results/results.jtl \
                            -e \
                            -o /workspace/jmeter-results/report || true
                    else
                        echo "No JMeter test files found, skipping..."
                    fi
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'jmeter-results/**/*', allowEmptyArchive: true
                }
            }
        }

        stage('Code Coverage') {
            steps {
                echo 'ðŸ“ˆ Generating JaCoCo Coverage Report...'
                sh '''
                    docker run --rm \
                        -v ${WORKSPACE_HOST}:/app \
                        -v maven-repo:/root/.m2 \
                        -w /app \
                        maven:3.9-eclipse-temurin-17 \
                        mvn jacoco:report -B || true
                '''
            }
            post {
                always {
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'target/site/jacoco',
                        reportFiles: 'index.html',
                        reportName: 'Java Coverage Report'
                    ])
                }
            }
        }

        stage('Stop Test Container') {
            steps {
                echo 'ðŸ›‘ Stopping test container...'
                sh '''
                    docker stop ${APP_NAME}-test || true
                    docker rm ${APP_NAME}-test || true
                '''
            }
        }

        stage('Generate Allure Report') {
            steps {
                echo 'ðŸ“Š Generating Allure Report...'
            }
            post {
                always {
                    allure([
                        includeProperties: false,
                        results: [[path: 'target/allure-results']]
                    ])
                }
            }
        }

        stage('Deploy to QA') {
            when {
                allOf {
                    branch 'main'
                    expression { currentBuild.currentResult == 'SUCCESS' }
                }
            }
            steps {
                echo 'ðŸš€ All tests passed! Deploying Manager App to QA...'

                withCredentials([sshUserPrivateKey(
                    credentialsId: 'ec2-ssh-key',
                    keyFileVariable: 'SSH_KEY'
                )]) {
                    sh '''
                        # Save and transfer Docker image
                        docker save ${APP_NAME}:${BUILD_VERSION} | gzip > ${APP_NAME}.tar.gz
                        scp -i ${SSH_KEY} -o StrictHostKeyChecking=no \
                            ${APP_NAME}.tar.gz ${EC2_USER}@${EC2_HOST}:/home/${EC2_USER}/

                        # Deploy on EC2
                        ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
                            echo "ðŸ”¨ Loading Docker image..."
                            gunzip -c ${APP_NAME}.tar.gz | docker load
                            rm ${APP_NAME}.tar.gz

                            echo "ðŸ›‘ Stopping existing container..."
                            docker stop expense-manager || true
                            docker rm expense-manager || true

                            echo "ðŸš€ Starting new container..."
                            docker run -d \
                                --name expense-manager \
                                --restart unless-stopped \
                                -p 5001:5001 \
                                -v expense-data:/data \
                                expense-manager:latest

                            sleep 30
                            curl -f http://localhost:5001/health && echo "âœ… Manager app deployed!"
EOF

                        rm ${APP_NAME}.tar.gz
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'ðŸ§¹ Cleaning up...'
            sh '''
                docker stop ${APP_NAME}-test || true
                docker rm ${APP_NAME}-test || true
                docker rmi ${APP_NAME}:${BUILD_VERSION} || true
            '''

            archiveArtifacts artifacts: '''
                target/surefire-reports/**/*.xml,
                target/allure-results/**/*,
                target/site/jacoco/**/*
            ''', allowEmptyArchive: true
        }

        success {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘  âœ… MANAGER APP PIPELINE COMPLETED SUCCESSFULLY              â•‘
            â•‘                                                              â•‘
            â•‘  ðŸ“Š Reports: Click "Allure Report" in sidebar                â•‘
            â•‘  ðŸ“ˆ Coverage: Click "Java Coverage Report"                   â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }

        failure {
            echo 'âŒ Pipeline failed! Check console output for details.'
        }
    }
}